<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .metric-card { margin-bottom: 1rem; }
        .status-indicator { 
            width: 12px; height: 12px; 
            border-radius: 50%; 
            display: inline-block; 
            margin-right: 5px; 
        }
        .status-online { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .chart-container { height: 400px; margin-bottom: 2rem; }
        .alert-item { 
            padding: 0.5rem; 
            margin-bottom: 0.5rem; 
            border-left: 4px solid #007bff; 
            background-color: #f8f9fa; 
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <nav class="navbar navbar-dark bg-dark">
            <div class="container-fluid">
                <span class="navbar-brand">リアルタイムデータ監視ダッシュボード</span>
                <span class="navbar-text">
                    <span id="system-status" class="status-indicator status-online"></span>
                    <span id="status-text">接続中</span>
                </span>
            </div>
        </nav>
        
        <div class="row mt-3">
            <!-- システム概要 -->
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-header">システム概要</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6"><small>データポイント/秒</small></div>
                            <div class="col-6"><span id="data-rate">-</span></div>
                        </div>
                        <div class="row">
                            <div class="col-6"><small>アクティブシンボル</small></div>
                            <div class="col-6"><span id="active-symbols">-</span></div>
                        </div>
                        <div class="row">
                            <div class="col-6"><small>平均品質スコア</small></div>
                            <div class="col-6"><span id="avg-quality">-</span></div>
                        </div>
                        <div class="row">
                            <div class="col-6"><small>キャッシュヒット率</small></div>
                            <div class="col-6"><span id="cache-hit-rate">-</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="card metric-card">
                    <div class="card-header">システム性能</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6"><small>CPU使用率</small></div>
                            <div class="col-6"><span id="cpu-usage">-</span></div>
                        </div>
                        <div class="row">
                            <div class="col-6"><small>メモリ使用量</small></div>
                            <div class="col-6"><span id="memory-usage">-</span></div>
                        </div>
                        <div class="row">
                            <div class="col-6"><small>ネットワーク遅延</small></div>
                            <div class="col-6"><span id="network-latency">-</span></div>
                        </div>
                    </div>
                </div>
                
                <div class="card metric-card">
                    <div class="card-header">エラー統計</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6"><small>エラー数</small></div>
                            <div class="col-6"><span id="error-count">-</span></div>
                        </div>
                        <div class="row">
                            <div class="col-6"><small>復旧数</small></div>
                            <div class="col-6"><span id="recovery-count">-</span></div>
                        </div>
                        <div class="row">
                            <div class="col-6"><small>アラート数</small></div>
                            <div class="col-6"><span id="alert-count">-</span></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- メインチャート -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">データ品質推移</div>
                    <div class="card-body">
                        <div id="quality-chart" class="chart-container"></div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">システムパフォーマンス</div>
                    <div class="card-body">
                        <div id="performance-chart" class="chart-container"></div>
                    </div>
                </div>
            </div>
            
            <!-- アラート・ログ -->
            <div class="col-md-3">
                <div class="card">
                    <div class="card-header">最新アラート</div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <div id="alerts-list"></div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">データソース状態</div>
                    <div class="card-body">
                        <div id="data-sources-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // WebSocket接続
        const ws = new WebSocket(`ws://${window.location.host}/ws`);
        
        ws.onopen = function(event) {
            console.log('WebSocket connected');
            updateStatus('online', '接続中');
        };
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            updateDashboard(data);
        };
        
        ws.onclose = function(event) {
            console.log('WebSocket disconnected');
            updateStatus('error', '接続切断');
            // 再接続試行
            setTimeout(() => location.reload(), 5000);
        };
        
        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
            updateStatus('error', 'エラー');
        };
        
        function updateStatus(status, text) {
            const indicator = document.getElementById('system-status');
            const statusText = document.getElementById('status-text');
            
            indicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
        }
        
        function updateDashboard(data) {
            if (data.type === 'metrics' && data.metrics) {
                updateMetrics(data.metrics);
            }
            if (data.type === 'alerts' && data.alerts) {
                updateAlerts(data.alerts);
            }
            if (data.type === 'quality_charts' && data.charts) {
                updateQualityCharts(data.charts);
            }
        }
        
        function updateMetrics(metrics) {
            document.getElementById('data-rate').textContent = 
                metrics.data_points_per_second.toFixed(1);
            document.getElementById('active-symbols').textContent = 
                metrics.active_symbols;
            document.getElementById('avg-quality').textContent = 
                metrics.avg_quality_score.toFixed(2);
            document.getElementById('cache-hit-rate').textContent = 
                (metrics.cache_hit_rate * 100).toFixed(1) + '%';
            document.getElementById('cpu-usage').textContent = 
                metrics.cpu_usage_percent.toFixed(1) + '%';
            document.getElementById('memory-usage').textContent = 
                metrics.memory_usage_mb.toFixed(0) + 'MB';
            document.getElementById('network-latency').textContent = 
                metrics.network_latency_ms.toFixed(0) + 'ms';
            document.getElementById('error-count').textContent = 
                metrics.error_count;
            document.getElementById('recovery-count').textContent = 
                metrics.recovery_count;
            document.getElementById('alert-count').textContent = 
                metrics.alert_count;
        }
        
        function updateAlerts(alerts) {
            const alertsList = document.getElementById('alerts-list');
            alertsList.innerHTML = '';
            
            alerts.slice(0, 10).forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert-item';
                alertDiv.innerHTML = `
                    <small class="text-muted">${new Date(alert.timestamp).toLocaleTimeString()}</small><br>
                    <strong>${alert.level}</strong>: ${alert.message}
                `;
                alertsList.appendChild(alertDiv);
            });
        }
        
        function updateQualityCharts(charts) {
            // 品質チャート更新
            if (charts.quality_chart) {
                Plotly.react('quality-chart', charts.quality_chart.data, charts.quality_chart.layout);
            }
            
            // パフォーマンスチャート更新
            if (charts.performance_chart) {
                Plotly.react('performance-chart', charts.performance_chart.data, charts.performance_chart.layout);
            }
        }
        
        // 初期データ読み込み
        async function loadInitialData() {
            try {
                const metricsResponse = await fetch('/api/metrics');
                const metrics = await metricsResponse.json();
                if (metrics && !metrics.error) {
                    updateMetrics(metrics);
                }
                
                const alertsResponse = await fetch('/api/alerts');
                const alerts = await alertsResponse.json();
                if (alerts && !alerts.error) {
                    updateAlerts(alerts);
                }
            } catch (error) {
                console.error('Error loading initial data:', error);
            }
        }
        
        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadInitialData();
            
            // 定期的な手動更新（WebSocketバックアップ）
            setInterval(loadInitialData, 30000);
        });
    </script>
</body>
</html>